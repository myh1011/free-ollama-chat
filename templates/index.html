<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat by myh1010(Test)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <h2>INTERNAL USE ONLY! by myh1010</h2>
    <a href="/about">About project</a>
    <div class="chat-container">
        <div class="server-select">
            <select id="ipSelect">
                {% for ip in ip_models.keys() %}
                <option value="{{ ip }}">{{ ip }}</option>
                {% endfor %}
            </select>
            <select id="modelSelect">
                {% for ip, models in ip_models.items() %}
                    {% if loop.first %}
                        {% for model in models %}
                            <option value="{{ model }}">{{ model }}</option>
                        {% endfor %}
                    {% endif %}
                {% endfor %}
            </select>
        </div>
        <div class="chat-history" id="chatHistory"></div>
        <div class="input-group" id="inputGroup">
            <input type="text" id="messageInput" placeholder="输入消息..." autocomplete="off">
            <button onclick="sendMessage()">发送</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        let currentMessage = null;
        let rawMessageBuffer = "";
        let eventSource = null;
        
        const ipSelect = document.getElementById('ipSelect');
        const modelSelect = document.getElementById('modelSelect');
        const chatHistory = document.getElementById('chatHistory');

        function initModelSelect() {
            const initialIP = ipSelect.value;
            fetch(`/api/models?ip=${encodeURIComponent(initialIP)}`)
                .then(response => response.json())
                .then(data => {
                    modelSelect.innerHTML = '';
                    data.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        modelSelect.appendChild(option);
                    });
                });
        }
        initModelSelect();

        ipSelect.addEventListener('change', () => {
            fetch(`/api/models?ip=${encodeURIComponent(ipSelect.value)}`)
                .then(response => response.json())
                .then(data => {
                    modelSelect.innerHTML = '';
                    data.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        modelSelect.appendChild(option);
                    });
                });
        });

        marked.setOptions({
            breaks: true,
            highlight: function(code, lang) {
                const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                return hljs.highlight(code, { language }).value;
            },
            sanitize: true
        });

        function createMessageElement(role) {
            const div = document.createElement('div');
            div.className = `${role}-message message`;
            return div;
        }

        function addThinkContent(content) {
            const thinkDiv = document.createElement('div');
            thinkDiv.className = 'think-bubble';
            thinkDiv.textContent = content;
            currentMessage.appendChild(thinkDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        let streamFinished = false;

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;

            if(eventSource && eventSource.close) eventSource.close();

            input.disabled = true;
            document.querySelector('button').disabled = true;
            document.getElementById('inputGroup').classList.add('disabled');

            const userDiv = createMessageElement('user');
            userDiv.textContent = message;
            chatHistory.appendChild(userDiv);

            currentMessage = createMessageElement('assistant');
            const contentDiv = document.createElement('div');
            currentMessage.appendChild(contentDiv);
            chatHistory.appendChild(currentMessage);
            
            rawMessageBuffer = "";
            streamFinished = false;

            try {
                const selectedIP = encodeURIComponent(ipSelect.value);
                const selectedModel = encodeURIComponent(modelSelect.value);
                if(!selectedIP || !selectedModel) {
                    throw new Error('请选择有效的IP和模型');
                }
                eventSource = new EventSource(
                    `/api/chat?ip=${selectedIP}&model=${selectedModel}&q=${encodeURIComponent(message)}`
                );

                eventSource.addEventListener('think', (e) => {
                    const data = JSON.parse(e.data);
                    addThinkContent(data.content);
                });

                eventSource.addEventListener('done', (e) => {
                    streamFinished = true;
                    eventSource.close();
                    input.disabled = false;
                    document.querySelector('button').disabled = false;
                    document.getElementById('inputGroup').classList.remove('disabled');
                });

                eventSource.addEventListener('message', (e) => {
                    const data = JSON.parse(e.data);
                    rawMessageBuffer += data.text;
                    contentDiv.innerHTML = marked.parse(rawMessageBuffer);

                    document.querySelectorAll('pre code').forEach(block => {
                        hljs.highlightElement(block);
                        const lang = block.className.replace('language-', '');
                        block.closest('pre').setAttribute('data-lang', lang || 'plaintext');
                    });
                    
                    chatHistory.scrollTop = chatHistory.scrollHeight;
                });

                eventSource.addEventListener('error', (e) => {
                    if (streamFinished) return;
                    if (e.eventPhase === EventSource.CLOSED) {
                        eventSource.close();
                    }
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'think-bubble';
                    errorDiv.style.color = '#ef4444';
                    errorDiv.textContent = '连接异常，请重试';
                    currentMessage.appendChild(errorDiv);
                    input.disabled = false;
                    document.querySelector('button').disabled = false;
                    document.getElementById('inputGroup').classList.remove('disabled');
                });

            } catch (error) {
                alert(`请求失败: ${error.message}`);
                input.disabled = false;
                document.querySelector('button').disabled = false;
                document.getElementById('inputGroup').classList.remove('disabled');
            }
        }

        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
    </script>
</body>
</html>
